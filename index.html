<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atendimento</title>
  <style>
    body{font-family:system-ui,Arial,sans-serif;background:#fff;margin:0;padding:24px}
    #lead-box{max-width:560px;margin:0 auto}
    input,button{width:100%}
    input{padding:14px;border:1px solid #ccc;border-radius:8px;margin:6px 0}
    button{padding:14px;border:0;border-radius:8px;background:#ff6a00;color:#fff;font-weight:700;cursor:pointer;margin-top:10px}
    h2{text-align:center;margin:0 0 12px}
    #lead-msg{display:none;text-align:center;padding:14px}
    #lead-err{display:none;text-align:center;padding:10px;color:#b00020;font-weight:600}
  </style>
</head>
<body>
  <div id="lead-box">
    <h2>Quero ser atendido agora</h2>
    <form id="lead-form">
      <input name="nome" placeholder="Seu nome" required>
      <input name="whatsapp" placeholder="WhatsApp (com DDD)" required>
      <input type="email" name="email" placeholder="E-mail" required>
      <button type="submit">Enviar e falar com um atendente</button>
    </form>
    <div id="lead-msg">Processando…</div>
    <div id="lead-err">Houve um erro. Tente novamente.</div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxQgonxhcUJ9URNB8a3b6Za3CnQNVGC87qxvc18PDLUjQOA37qs-q7r9z42ZL7YL0RnkA/exec";
    const getUTMs=()=>{const p=new URLSearchParams(location.search),o={};["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach(k=>{if(p.get(k))o[k]=p.get(k)});return o};
    const digits=v=>(v||"").replace(/[^\d]/g,"");
    const wa=(f,t)=>`https://api.whatsapp.com/send?phone=${f}&text=${encodeURIComponent(t)}`;
    const go=u=>{try{window.top.location.href=u}catch(_){window.open(u,"_blank")}};
    const form=document.getElementById("lead-form"), msg=document.getElementById("lead-msg"), err=document.getElementById("lead-err");
    form.addEventListener("submit",async e=>{
      e.preventDefault(); err.style.display="none"; msg.style.display="block";
      const payload={ nome:(form.nome.value||"").trim(), whatsapp:digits(form.whatsapp.value), email:(form.email.value||"").trim().toLowerCase(), ...getUTMs() };
      try{
        const r=await fetch(API_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
        const data=await r.json();
        if(!data||!data.ok||!data.atendente||!data.atendente.fone) throw new Error(data&&data.error?data.error:"Resposta inválida");
        const texto=`${payload.nome?payload.nome+", ":""}recebemos seu cadastro e vamos te atender agora.`;
        go(wa(data.atendente.fone,texto));
      }catch(err_){ console.log("ERRO:",err_); msg.style.display="none"; err.style.display="block"; }
    });
  </script>
</body>
</html>
